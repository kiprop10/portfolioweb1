doctype html
html
  head
    title #{title || 'Kiprop Mutai'}
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    style.
      * {
        box-sizing: border-box;
      }
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background: linear-gradient(120deg, #f3e8ff, #f0fff4);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        font-size: 1.05em;
      }
      nav {
        background: linear-gradient(90deg, #f59e42 0%, #a21caf 100%);
        padding: 1.2rem 0;
        text-align: center;
        box-shadow: 0 2px 12px #0002;
      }
      nav a, nav button {
        color: #fff;
        text-decoration: none;
        margin: 0 1.2rem;
        font-size: 1.1em;
        font-weight: 600;
        padding: 0.5em 1em;
        border-radius: 0.5em;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      nav a:hover, nav button:hover {
        background: #fff3e0;
        color: #a21caf;
      }
      .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 2rem;
        background: #fff;
        border-radius: 1.2rem;
        box-shadow: 0 6px 20px #0001;
        flex: 1;
      }
      h1, h2, h3 {
        color: #a21caf;
        font-family: 'Playfair Display', serif;
        margin-top: 0;
      }

      /* ==== Modal Styles ==== */
      #cv-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }
      #cv-modal .modal-content {
        background: #fff;
        padding: 2em;
        border-radius: 1em;
        min-width: 300px;
        box-shadow: 0 12px 32px #0003;
        text-align: center;
      }
      #cv-modal input[type="password"] {
        width: 90%;
        padding: 0.6em;
        font-size: 1em;
        border-radius: 0.5em;
        border: 2px solid #ddd;
        margin-bottom: 1em;
      }
      #cv-modal .error {
        color: #c00;
        margin-top: 1em;
        font-size: 0.95em;
      }
      #cv-modal button {
        margin: 0.5em;
        padding: 0.5em 1.4em;
        font-size: 1em;
        border: none;
        border-radius: 0.5em;
        cursor: pointer;
        background: linear-gradient(90deg, #a21caf, #f59e42);
        color: #fff;
        transition: background 0.2s;
      }
      #cv-modal button:hover {
        background: linear-gradient(90deg, #f59e42, #a21caf);
      }

      footer {
        background: #a21caf;
        color: #fff;
        text-align: center;
        padding: 1.2rem 0;
        font-size: 1em;
        letter-spacing: 0.04em;
      }

  body
    nav
      a(href="/") Home
      a(href="/messages") Messages
      a(href="/blog") Blog
      button(type="button", id="download-cv-btn") Download CV

    .container
      block content

    // Modal for secure CV download
    #cv-modal
      .modal-content
        h3 Enter Password to Download CV
        input#cv-password(type="password" placeholder="Password")
        div
          button(type="button", id="cv-submit-btn") Submit
          button(type="button", onclick="document.getElementById('cv-modal').style.display='none'") Cancel
        div#error-msg.error

    footer
      | &copy; #{new Date().getFullYear()} Kiprop Mutai

    // Scripts for modal logic + secure download
    script.
      window.onload = function () {
        const modal = document.getElementById('cv-modal');
        const openBtn = document.getElementById('download-cv-btn');
        const submitBtn = document.getElementById('cv-submit-btn');
        const passwordInput = document.getElementById('cv-password');
        const errorDiv = document.getElementById('error-msg');

        openBtn.onclick = () => {
          modal.style.display = 'flex';
          passwordInput.value = '';
          errorDiv.innerText = '';
        };

        submitBtn.onclick = async () => {
          const password = passwordInput.value;
          errorDiv.innerText = '';
          try {
            const res = await fetch('/cv/password-check', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password })
            });
            if (!res.ok) {
              const data = await res.json();
              errorDiv.innerText = data.error || 'Incorrect password';
              return;
            }
            const { token } = await res.json();
            const downloadRes = await fetch(`/cv/download?token=${token}`);
            if (!downloadRes.ok) {
              errorDiv.innerText = 'Download failed.';
              return;
            }
            const blob = await downloadRes.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'KipropMutai-CV.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            modal.style.display = 'none';
          } catch (err) {
            errorDiv.innerText = 'Network error. Please try again.';
          }
        };
      };